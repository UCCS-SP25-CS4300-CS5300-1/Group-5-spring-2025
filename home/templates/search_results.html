<!-- inherit from base.html-->
{% extends "base_template.html" %}
{% load static %}


<!-- Replace block content in base_template.html BEFORE I MESS EVERYTHING UP-->
{% block content %}

<div class="results-container">
    <div class="campsite-list">

{% if campsites %}
    <h2 class="search-results">Results For {{ query }}</h2>
    <ul>
        {% for site in campsites %}
            <li class="campsite-items">
                <a href="{% url 'facility_detail' site.FacilityID %}?q={{ request.GET.q }}" style="color: #ff930e">
                    <strong>{{ site.FacilityName }}</strong> - {{ site.FacilityTypeDescription }}
                </a>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p>No results found.</p>
{% endif %}

</div>

 <!-- Display Map -->
 <div class="map-container">
    <div id="map"></div>
</div>
</div>

<!-- Leaflet.js CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    #map {
        height: 450px;
        width: 100%;
        border-radius: 16px;
        margin-bottom: 20px;
    }
</style>

<div class="d-flex justify-content-center">
    <button onclick="locateUser()" class="btn btn-primary">Show My Location</button>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        var map = L.map('map').setView([39.5, -98.35], 5); // Default center (USA)

        // Add tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Dynamically insert markers based on Django context
        var campsites = [
            {% for site in campsites %}
                {
                    name: "{{ site.FacilityName|escapejs }}",
                    lat: {{ site.FacilityLatitude|default:"null" }},
                    lon: {{ site.FacilityLongitude|default:"null" }},
                    type: "{{ site.FacilityTypeDescription|escapejs }}",
                    id: "{{ site.FacilityID }}"
                },
            {% endfor %}
        ];

        // Function to locate the user and add a marker
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;
                    var radiusGPS = 40233;

                    // Add a marker at the user's location
                    var userMarker = L.marker([lat, lon]).addTo(map)
                        .bindPopup("<b>Your Location</b><br>Latitude: " + lat.toFixed(2) + "<br>Longitude: " + lon.toFixed(2) + "<br>Radius: 1 Mile.")
                        .openPopup();

                    // Add a circle to represent the accuracy
                    var accuracyCircle = L.circle([lat, lon], { radius: radiusGPS }).addTo(map);

                    // Center the map on the user's location
                    map.setView([lat, lon], 13);
                },
                function(error) {
                    alert("Error retrieving location: " + error.message);
                }
            );
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }
        // Add markers to the map
        campsites.forEach(function (site) {
            if (site.lat && site.lon) {
                L.marker([site.lat, site.lon]).addTo(map)
                    .bindPopup(`<b>${site.name}</b><br>Type: ${site.type}<br>
                                <a href="/facility/${site.id}?q={{ request.GET.q }}">View Details</a>`);
            }
        });
    });

</script>


{% endblock %}
